from flask import Flask, request, jsonify
from PIL import Image
import numpy as np
from flask_cors import CORS

LEGO_COLORS = [
    {"id": 0, "name": "Black", "rgb": [5, 19, 29]},
    {"id": 1, "name": "Blue", "rgb": [0, 85, 191]},
    {"id": 2, "name": "Green", "rgb": [35, 120, 65]},
    {"id": 3, "name": "Dark Turquoise", "rgb": [0, 143, 155]},
    {"id": 4, "name": "Red", "rgb": [201, 26, 9]},
    {"id": 5, "name": "Dark Pink", "rgb": [200, 112, 160]},
    {"id": 6, "name": "Brown", "rgb": [88, 57, 39]},
    {"id": 7, "name": "Light Gray", "rgb": [155, 161, 157]},
    {"id": 8, "name": "Dark Gray", "rgb": [109, 110, 92]},
    {"id": 9, "name": "Light Blue", "rgb": [180, 210, 227]},
    {"id": 10, "name": "Bright Green", "rgb": [75, 159, 74]},
    {"id": 11, "name": "Light Turquoise", "rgb": [85, 165, 175]},
    {"id": 12, "name": "Salmon", "rgb": [242, 112, 94]},
    {"id": 13, "name": "Pink", "rgb": [252, 151, 172]},
    {"id": 14, "name": "Yellow", "rgb": [242, 205, 55]},
    {"id": 15, "name": "White", "rgb": [255, 255, 255]},
    {"id": 17, "name": "Light Green", "rgb": [194, 218, 184]},
    {"id": 18, "name": "Light Yellow", "rgb": [251, 230, 150]},
    {"id": 19, "name": "Tan", "rgb": [228, 205, 158]},
    {"id": 20, "name": "Light Violet", "rgb": [201, 202, 226]},
    {"id": 21, "name": "Glow In Dark Opaque", "rgb": [212, 213, 201]},
    {"id": 22, "name": "Purple", "rgb": [129, 0, 123]},
    {"id": 23, "name": "Dark Blue-Violet", "rgb": [32, 50, 176]},
    {"id": 25, "name": "Orange", "rgb": [254, 138, 24]},
    {"id": 26, "name": "Magenta", "rgb": [146, 57, 120]},
    {"id": 27, "name": "Lime", "rgb": [187, 233, 11]},
    {"id": 28, "name": "Dark Tan", "rgb": [149, 138, 115]},
    {"id": 29, "name": "Bright Pink", "rgb": [228, 173, 200]},
    {"id": 30, "name": "Medium Lavender", "rgb": [172, 120, 186]},
    {"id": 31, "name": "Lavender", "rgb": [225, 213, 237]},
    {"id": 32, "name": "Trans-Black IR Lens", "rgb": [99, 95, 82]},
    {"id": 33, "name": "Trans-Dark Blue", "rgb": [0, 32, 160]},
    {"id": 34, "name": "Trans-Green", "rgb": [132, 182, 141]},
    {"id": 35, "name": "Trans-Bright Green", "rgb": [217, 228, 167]},
    {"id": 36, "name": "Trans-Red", "rgb": [201, 26, 9]},
    {"id": 40, "name": "Trans-Brown", "rgb": [99, 95, 82]},
    {"id": 41, "name": "Trans-Light Blue", "rgb": [174, 239, 236]},
    {"id": 42, "name": "Trans-Neon Green", "rgb": [248, 241, 132]},
    {"id": 43, "name": "Trans-Very Lt Blue", "rgb": [193, 223, 240]},
    {"id": 45, "name": "Trans-Dark Pink", "rgb": [223, 102, 149]},
    {"id": 46, "name": "Trans-Yellow", "rgb": [245, 205, 47]},
    {"id": 47, "name": "Trans-Clear", "rgb": [252, 252, 252]},
    {"id": 52, "name": "Trans-Purple", "rgb": [165, 165, 203]},
    {"id": 54, "name": "Trans-Neon Yellow", "rgb": [218, 176, 0]},
    {"id": 57, "name": "Trans-Neon Orange", "rgb": [255, 128, 13]},
    {"id": 60, "name": "Chrome Antique Brass", "rgb": [100, 90, 76]},
    {"id": 61, "name": "Chrome Blue", "rgb": [108, 150, 191]},
    {"id": 62, "name": "Chrome Green", "rgb": [60, 179, 113]},
    {"id": 63, "name": "Chrome Pink", "rgb": [170, 77, 142]},
    {"id": 64, "name": "Chrome Black", "rgb": [27, 42, 52]},
    {"id": 68, "name": "Very Light Orange", "rgb": [243, 207, 155]},
    {"id": 69, "name": "Light Purple", "rgb": [205, 98, 152]},
    {"id": 70, "name": "Reddish Brown", "rgb": [88, 42, 18]},
    {"id": 71, "name": "Light Bluish Gray", "rgb": [160, 165, 169]},
    {"id": 72, "name": "Dark Bluish Gray", "rgb": [108, 110, 104]},
    {"id": 73, "name": "Medium Blue", "rgb": [90, 147, 219]},
    {"id": 74, "name": "Medium Green", "rgb": [115, 220, 161]},
    {"id": 75, "name": "Speckle Black-Copper", "rgb": [5, 19, 29]},
    {"id": 76, "name": "Speckle DBGray-Silver", "rgb": [108, 110, 104]},
    {"id": 77, "name": "Light Pink", "rgb": [254, 204, 207]},
    {"id": 78, "name": "Light Nougat", "rgb": [246, 215, 179]},
    {"id": 79, "name": "Milky White", "rgb": [255, 255, 255]},
    {"id": 80, "name": "Metallic Silver", "rgb": [165, 169, 180]},
    {"id": 81, "name": "Metallic Green", "rgb": [137, 155, 95]},
    {"id": 82, "name": "Metallic Gold", "rgb": [219, 172, 52]},
    {"id": 84, "name": "Medium Nougat", "rgb": [170, 125, 85]},
    {"id": 85, "name": "Dark Purple", "rgb": [63, 54, 145]},
    {"id": 86, "name": "Light Brown", "rgb": [124, 80, 58]},
    {"id": 89, "name": "Royal Blue", "rgb": [76, 97, 219]},
    {"id": 92, "name": "Nougat", "rgb": [208, 145, 104]},
    {"id": 100, "name": "Light Salmon", "rgb": [254, 186, 189]},
    {"id": 110, "name": "Violet", "rgb": [67, 84, 163]},
    {"id": 112, "name": "Medium Bluish Violet", "rgb": [104, 116, 202]},
    {"id": 114, "name": "Glitter Trans-Dark Pink", "rgb": [223, 102, 149]},
    {"id": 115, "name": "Medium Lime", "rgb": [199, 210, 60]},
    {"id": 117, "name": "Glitter Trans-Clear", "rgb": [255, 255, 255]},
    {"id": 118, "name": "Aqua", "rgb": [179, 215, 209]},
    {"id": 120, "name": "Light Lime", "rgb": [217, 228, 167]},
    {"id": 125, "name": "Light Orange", "rgb": [249, 186, 97]},
    {"id": 129, "name": "Glitter Trans-Purple", "rgb": [165, 165, 203]},
    {"id": 132, "name": "Speckle Black-Silver", "rgb": [5, 19, 29]},
    {"id": 133, "name": "Speckle Black-Gold", "rgb": [5, 19, 29]},
    {"id": 134, "name": "Copper", "rgb": [174, 122, 89]},
    {"id": 135, "name": "Pearl Light Gray", "rgb": [156, 163, 168]},
    {"id": 137, "name": "Pearl Sand Blue", "rgb": [121, 136, 161]},
    {"id": 142, "name": "Pearl Light Gold", "rgb": [220, 188, 129]},
    {"id": 143, "name": "Trans-Medium Blue", "rgb": [207, 226, 247]},
    {"id": 148, "name": "Pearl Dark Gray", "rgb": [87, 88, 87]},
    {"id": 150, "name": "Pearl Very Light Gray", "rgb": [171, 173, 172]},
    {"id": 151, "name": "Very Light Bluish Gray", "rgb": [230, 227, 224]},
    {"id": 158, "name": "Yellowish Green", "rgb": [223, 238, 165]},
    {"id": 178, "name": "Flat Dark Gold", "rgb": [180, 132, 85]},
    {"id": 179, "name": "Flat Silver", "rgb": [137, 135, 136]},
    {"id": 182, "name": "Trans-Orange", "rgb": [240, 143, 28]},
    {"id": 183, "name": "Pearl White", "rgb": [242, 243, 242]},
    {"id": 191, "name": "Bright Light Orange", "rgb": [248, 187, 61]},
    {"id": 212, "name": "Bright Light Blue", "rgb": [159, 195, 233]},
    {"id": 216, "name": "Rust", "rgb": [179, 16, 4]},
    {"id": 226, "name": "Bright Light Yellow", "rgb": [255, 240, 58]},
    {"id": 230, "name": "Trans-Pink", "rgb": [228, 173, 200]},
    {"id": 232, "name": "Sky Blue", "rgb": [125, 191, 221]},
    {"id": 236, "name": "Trans-Light Purple", "rgb": [150, 112, 159]},
    {"id": 272, "name": "Dark Blue", "rgb": [10, 52, 99]},
    {"id": 288, "name": "Dark Green", "rgb": [24, 70, 50]},
    {"id": 294, "name": "Glow In Dark Trans", "rgb": [189, 198, 173]},
    {"id": 297, "name": "Pearl Gold", "rgb": [170, 127, 46]},
    {"id": 308, "name": "Dark Brown", "rgb": [53, 33, 0]},
    {"id": 313, "name": "Maersk Blue", "rgb": [53, 146, 195]},
    {"id": 320, "name": "Dark Red", "rgb": [114, 14, 15]},
    {"id": 321, "name": "Dark Azure", "rgb": [7, 139, 201]},
    {"id": 322, "name": "Medium Azure", "rgb": [54, 174, 191]},
    {"id": 323, "name": "Light Aqua", "rgb": [173, 195, 192]},
    {"id": 326, "name": "Olive Green", "rgb": [155, 154, 90]},
    {"id": 334, "name": "Chrome Gold", "rgb": [187, 165, 61]},
    {"id": 335, "name": "Sand Red", "rgb": [214, 117, 114]},
    {"id": 351, "name": "Medium Dark Pink", "rgb": [247, 133, 177]},
    {"id": 366, "name": "Earth Orange", "rgb": [250, 156, 28]},
    {"id": 373, "name": "Sand Purple", "rgb": [132, 94, 132]},
    {"id": 378, "name": "Sand Green", "rgb": [160, 188, 172]},
    {"id": 379, "name": "Sand Blue", "rgb": [96, 116, 161]},
    {"id": 383, "name": "Chrome Silver", "rgb": [224, 224, 224]},
    {"id": 450, "name": "Fabuland Brown", "rgb": [182, 123, 80]},
    {"id": 462, "name": "Medium Orange", "rgb": [255, 167, 11]},
    {"id": 484, "name": "Dark Orange", "rgb": [169, 85, 0]},
    {"id": 503, "name": "Very Light Gray", "rgb": [230, 227, 218]},
    {"id": 1000, "name": "Glow in Dark White", "rgb": [217, 217, 217]},
    {"id": 1001, "name": "Medium Violet", "rgb": [147, 145, 228]},
    {"id": 1002, "name": "Glitter Trans-Neon Green", "rgb": [192, 245, 0]},
    {"id": 1003, "name": "Glitter Trans-Light Blue", "rgb": [104, 188, 197]},
    {"id": 1004, "name": "Trans-Flame Yellowish Orange", "rgb": [252, 183, 109]},
    {"id": 1005, "name": "Trans-Fire Yellow", "rgb": [251, 232, 144]},
    {"id": 1006, "name": "Trans-Light Royal Blue", "rgb": [180, 212, 247]},
    {"id": 1007, "name": "Reddish Lilac", "rgb": [142, 85, 151]},
    {"id": 1008, "name": "Vintage Blue", "rgb": [3, 156, 189]},
    {"id": 1009, "name": "Vintage Green", "rgb": [30, 96, 30]},
    {"id": 1010, "name": "Vintage Red", "rgb": [202, 31, 8]},
    {"id": 1011, "name": "Vintage Yellow", "rgb": [243, 195, 5]},
    {"id": 1012, "name": "Fabuland Orange", "rgb": [239, 145, 33]},
    {"id": 1013, "name": "Modulex White", "rgb": [244, 244, 244]},
    {"id": 1014, "name": "Modulex Light Bluish Gray", "rgb": [175, 181, 199]},
    {"id": 1015, "name": "Modulex Light Gray", "rgb": [156, 156, 156]},
    {"id": 1016, "name": "Modulex Charcoal Gray", "rgb": [89, 93, 96]},
    {"id": 1017, "name": "Modulex Tile Gray", "rgb": [107, 90, 90]},
    {"id": 1018, "name": "Modulex Black", "rgb": [77, 76, 82]},
    {"id": 1019, "name": "Modulex Tile Brown", "rgb": [51, 0, 0]},
    {"id": 1020, "name": "Modulex Terracotta", "rgb": [92, 80, 48]},
    {"id": 1021, "name": "Modulex Brown", "rgb": [144, 116, 80]},
    {"id": 1022, "name": "Modulex Buff", "rgb": [222, 198, 156]},
    {"id": 1023, "name": "Modulex Red", "rgb": [181, 44, 32]},
    {"id": 1024, "name": "Modulex Pink Red", "rgb": [244, 92, 64]},
    {"id": 1025, "name": "Modulex Orange", "rgb": [244, 123, 48]},
    {"id": 1026, "name": "Modulex Light Orange", "rgb": [247, 173, 99]},
    {"id": 1027, "name": "Modulex Light Yellow", "rgb": [255, 227, 113]},
    {"id": 1028, "name": "Modulex Ochre Yellow", "rgb": [254, 213, 87]},
    {"id": 1029, "name": "Modulex Lemon", "rgb": [189, 198, 24]},
    {"id": 1030, "name": "Modulex Pastel Green", "rgb": [125, 181, 56]},
    {"id": 1031, "name": "Modulex Olive Green", "rgb": [124, 144, 81]},
    {"id": 1032, "name": "Modulex Aqua Green", "rgb": [39, 134, 126]},
    {"id": 1033, "name": "Modulex Teal Blue", "rgb": [70, 112, 131]},
    {"id": 1034, "name": "Modulex Tile Blue", "rgb": [0, 87, 166]},
    {"id": 1035, "name": "Modulex Medium Blue", "rgb": [97, 175, 255]},
    {"id": 1036, "name": "Modulex Pastel Blue", "rgb": [104, 174, 206]},
    {"id": 1037, "name": "Modulex Violet", "rgb": [189, 125, 133]},
    {"id": 1038, "name": "Modulex Pink", "rgb": [247, 133, 177]},
    {"id": 1039, "name": "Modulex Clear", "rgb": [255, 255, 255]},
    {"id": 1040, "name": "Modulex Foil Dark Gray", "rgb": [89, 93, 96]},
    {"id": 1041, "name": "Modulex Foil Light Gray", "rgb": [156, 156, 156]},
    {"id": 1042, "name": "Modulex Foil Dark Green", "rgb": [0, 100, 0]},
    {"id": 1043, "name": "Modulex Foil Light Green", "rgb": [125, 181, 56]},
    {"id": 1044, "name": "Modulex Foil Dark Blue", "rgb": [0, 87, 166]},
    {"id": 1045, "name": "Modulex Foil Light Blue", "rgb": [104, 174, 206]},
    {"id": 1046, "name": "Modulex Foil Violet", "rgb": [75, 0, 130]},
    {"id": 1047, "name": "Modulex Foil Red", "rgb": [139, 0, 0]},
    {"id": 1048, "name": "Modulex Foil Yellow", "rgb": [254, 213, 87]},
    {"id": 1049, "name": "Modulex Foil Orange", "rgb": [247, 173, 99]},
    {"id": 1050, "name": "Coral", "rgb": [255, 105, 143]},
    {"id": 1051, "name": "Pastel Blue", "rgb": [90, 196, 218]},
    {"id": 1052, "name": "Glitter Trans-Orange", "rgb": [240, 143, 28]},
    {"id": 1053, "name": "Opal Trans-Light Blue", "rgb": [104, 188, 197]},
    {"id": 1054, "name": "Opal Trans-Dark Pink", "rgb": [206, 29, 155]},
    {"id": 1055, "name": "Opal Trans-Clear", "rgb": [252, 252, 252]},
    {"id": 1056, "name": "Opal Trans-Brown", "rgb": [88, 57, 39]},
    {"id": 1057, "name": "Trans-Light Bright Green", "rgb": [201, 231, 136]},
    {"id": 1058, "name": "Trans-Light Green", "rgb": [148, 229, 171]},
    {"id": 1059, "name": "Opal Trans-Purple", "rgb": [131, 32, 183]},
    {"id": 1060, "name": "Opal Trans-Bright Green", "rgb": [132, 182, 141]},
    {"id": 1061, "name": "Opal Trans-Dark Blue", "rgb": [0, 32, 160]},
    {"id": 1062, "name": "Vibrant Yellow", "rgb": [235, 216, 0]},
    {"id": 1063, "name": "Pearl Copper", "rgb": [180, 106, 0]},
    {"id": 1064, "name": "Fabuland Red", "rgb": [255, 128, 20]},
    {"id": 1065, "name": "Reddish Gold", "rgb": [172, 130, 71]},
    {"id": 1066, "name": "Curry", "rgb": [221, 152, 46]},
    {"id": 1067, "name": "Dark Nougat", "rgb": [173, 97, 64]},
    {"id": 1068, "name": "Bright Reddish Orange", "rgb": [238, 84, 52]},
    {"id": 1069, "name": "Pearl Red", "rgb": [214, 0, 38]},
    {"id": 1070, "name": "Pearl Blue", "rgb": [0, 89, 163]},
    {"id": 1071, "name": "Pearl Green", "rgb": [0, 142, 60]},
    {"id": 1072, "name": "Pearl Brown", "rgb": [87, 57, 44]},
    {"id": 1073, "name": "Pearl Black", "rgb": [10, 19, 39]},
    {"id": 1074, "name": "Duplo Blue", "rgb": [0, 158, 206]},
    {"id": 1075, "name": "Duplo Medium Blue", "rgb": [62, 149, 182]},
    {"id": 1076, "name": "Duplo Lime", "rgb": [255, 242, 48]},
    {"id": 1077, "name": "Fabuland Lime", "rgb": [120, 252, 120]},
    {"id": 1078, "name": "Duplo Medium Green", "rgb": [70, 138, 95]},
    {"id": 1079, "name": "Duplo Light Green", "rgb": [96, 186, 118]},
    {"id": 1080, "name": "Light Tan", "rgb": [243, 201, 136]},
    {"id": 1081, "name": "Rust Orange", "rgb": [135, 43, 23]},
    {"id": 1082, "name": "Clikits Pink", "rgb": [254, 120, 176]},
    {"id": 1083, "name": "Two-tone Copper", "rgb": [148, 81, 72]},
    {"id": 1084, "name": "Two-tone Gold", "rgb": [171, 103, 58]},
    {"id": 1085, "name": "Two-tone Silver", "rgb": [115, 114, 113]},
    {"id": 1086, "name": "Pearl Lime", "rgb": [106, 121, 68]},
    {"id": 1087, "name": "Duplo Pink", "rgb": [255, 135, 156]},
    {"id": 1088, "name": "Medium Brown", "rgb": [117, 89, 69]},
    {"id": 1089, "name": "Warm Tan", "rgb": [204, 163, 115]},
    {"id": 1090, "name": "Duplo Turquoise", "rgb": [63, 182, 158]},
    {"id": 1091, "name": "Warm Yellowish Orange", "rgb": [255, 203, 120]},
    {"id": 1092, "name": "Metallic Copper", "rgb": [118, 77, 59]},
    {"id": 1093, "name": "Light Lilac", "rgb": [145, 149, 202]},
    {"id": 1094, "name": "Trans-Medium Purple", "rgb": [141, 115, 179]},
    {"id": 1095, "name": "Trans-Black", "rgb": [99, 95, 82]},
    {"id": 1096, "name": "Glitter Trans-Bright Green", "rgb": [217, 228, 167]},
    {"id": 1097, "name": "Glitter Trans-Medium Purple", "rgb": [141, 115, 179]},
    {"id": 1098, "name": "Glitter Trans-Green", "rgb": [132, 182, 141]},
    {"id": 1099, "name": "Glitter Trans-Pink", "rgb": [228, 173, 200]},
    {"id": 1100, "name": "Clikits Yellow", "rgb": [255, 207, 11]},
    {"id": 1101, "name": "Duplo Dark Purple", "rgb": [95, 39, 170]},
    {"id": 1102, "name": "Trans-Neon Red", "rgb": [255, 0, 64]},
    {"id": 1103, "name": "Pearl Titanium", "rgb": [62, 60, 57]},
    {"id": 1104, "name": "HO Aqua", "rgb": [179, 215, 209]},
    {"id": 1105, "name": "HO Azure", "rgb": [21, 145, 203]},
    {"id": 1106, "name": "HO Blue-gray", "rgb": [53, 78, 90]},
    {"id": 1107, "name": "HO Cyan", "rgb": [91, 152, 179]},
    {"id": 1108, "name": "HO Dark Aqua", "rgb": [167, 220, 207]},
    {"id": 1109, "name": "HO Dark Blue", "rgb": [10, 52, 99]},
    {"id": 1110, "name": "HO Dark Gray", "rgb": [109, 110, 92]},
    {"id": 1111, "name": "HO Dark Green", "rgb": [24, 70, 50]},
    {"id": 1112, "name": "HO Dark Lime", "rgb": [178, 185, 85]},
    {"id": 1113, "name": "HO Dark Red", "rgb": [99, 19, 20]},
    {"id": 1114, "name": "HO Dark Sand Green", "rgb": [98, 122, 98]},
    {"id": 1115, "name": "HO Dark Turquoise", "rgb": [16, 146, 157]},
    {"id": 1116, "name": "HO Earth Orange", "rgb": [187, 119, 27]},
    {"id": 1117, "name": "HO Gold", "rgb": [180, 167, 116]},
    {"id": 1118, "name": "HO Light Aqua", "rgb": [163, 209, 192]},
    {"id": 1119, "name": "HO Light Brown", "rgb": [150, 83, 54]},
    {"id": 1120, "name": "HO Light Gold", "rgb": [205, 194, 152]},
    {"id": 1121, "name": "HO Light Tan", "rgb": [249, 241, 199]},
    {"id": 1122, "name": "HO Light Yellow", "rgb": [245, 250, 183]},
    {"id": 1123, "name": "HO Medium Blue", "rgb": [115, 150, 200]},
    {"id": 1124, "name": "HO Medium Red", "rgb": [192, 17, 17]},
    {"id": 1125, "name": "HO Metallic Blue", "rgb": [13, 71, 99]},
    {"id": 1126, "name": "HO Metallic Dark Gray", "rgb": [94, 94, 94]},
    {"id": 1127, "name": "HO Metallic Green", "rgb": [135, 152, 103]},
    {"id": 1128, "name": "HO Metallic Sand Blue", "rgb": [95, 125, 140]},
    {"id": 1129, "name": "HO Olive Green", "rgb": [155, 154, 90]},
    {"id": 1130, "name": "HO Rose", "rgb": [208, 98, 98]},
    {"id": 1131, "name": "HO Sand Blue", "rgb": [110, 138, 166]},
    {"id": 1132, "name": "HO Sand Green", "rgb": [160, 188, 172]},
    {"id": 1133, "name": "HO Tan", "rgb": [228, 205, 158]},
    {"id": 1134, "name": "HO Titanium", "rgb": [97, 97, 97]},
    {"id": 1135, "name": "Metal", "rgb": [165, 173, 180]},
    {"id": 1136, "name": "Reddish Orange", "rgb": [202, 76, 11]},
    {"id": 1137, "name": "Sienna Brown", "rgb": [145, 92, 60]},
    {"id": 1138, "name": "Umber Brown", "rgb": [94, 63, 51]},
    {"id": 1139, "name": "Opal Trans-Yellow", "rgb": [245, 205, 47]},
    {"id": 1140, "name": "Neon Orange", "rgb": [236, 70, 18]},
    {"id": 1141, "name": "Neon Green", "rgb": [210, 252, 67]},
    {"id": 1142, "name": "Dark Olive Green", "rgb": [93, 92, 54]},
    {"id": 1143, "name": "Glitter Milky White", "rgb": [255, 255, 255]},
    {"id": 1144, "name": "Chrome Red", "rgb": [206, 48, 33]},
    {"id": 1145, "name": "Ochre Yellow", "rgb": [221, 158, 71]},
    {"id": 9999, "name": "[No Color/Any Color]", "rgb": [5, 19, 29]},
]


app = Flask(__name__)
CORS(app)  # Enable CORS for all routes


# Helper: get mean RGB of ALL pixels (no white skipping)
def mean_rgb(arr):
    arr = arr.reshape(-1, 3)
    if arr.size == 0:
        return np.array([255, 255, 255])  # fallback to white
    return arr.mean(axis=0).astype(int)


def closest_lego_color(rgb):
    def dist(c):
        return sum((a - b) ** 2 for a, b in zip(c["rgb"], rgb))

    return min(LEGO_COLORS, key=dist)


@app.route("/detect_color", methods=["POST"])
def detect_color():
    file = request.files["image"]
    left = float(request.form["left"])
    upper = float(request.form["upper"])
    right = float(request.form["right"])
    lower = float(request.form["lower"])

    # Round to int for cropping (Pillow)
    left, upper, right, lower = map(int, map(round, [left, upper, right, lower]))
    img = Image.open(file).convert("RGB")
    cropped = img.crop((left, upper, right, lower))
    arr = np.array(cropped)
    if arr.size == 0:
        mean_color = np.array([255, 255, 255])
    else:
        mean_color = mean_rgb(arr)

    mean_color = mean_rgb(arr)
    hex_color = "#%02x%02x%02x" % tuple(mean_color)
    lego_color = closest_lego_color(mean_color)

    return jsonify(
        {
            "mean_rgb": mean_color.tolist(),
            "hex": hex_color,
            "lego_color": lego_color["name"],
            "lego_color_id": lego_color["id"],
            "lego_color_rgb": lego_color["rgb"],
        }
    )


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5001, debug=True)
